<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Office — System Architecture</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

  :root {
    --bg: #f8f9fb;
    --surface: #ffffff;
    --surface-alt: #f1f3f8;
    --border: #dfe3ec;
    --border-accent: #c4cad8;
    --text: #1a1f36;
    --text-muted: #525f7f;
    --text-dim: #8792a2;
    --blue: #0078D4;
    --blue-bg: #E8F1FB;
    --purple: #6B21A8;
    --purple-bg: #F3E8FF;
    --cyan: #0E7490;
    --cyan-bg: #E0F7FA;
    --green: #15803D;
    --green-bg: #E8F5E9;
    --orange: #C2410C;
    --orange-bg: #FFF3E0;
    --pink: #BE185D;
    --pink-bg: #FCE4EC;
    --red: #B91C1C;
    --red-bg: #FEE2E2;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ─── Header ─── */
  .header {
    text-align: center;
    padding: 48px 40px 32px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .header h1 {
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--text);
    margin-bottom: 4px;
  }
  .header .subtitle {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 400;
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }
  .header .date {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 6px;
  }

  /* ─── Stats Bar ─── */
  .stats-bar {
    display: flex;
    justify-content: center;
    gap: 48px;
    padding: 20px 20px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .stat { text-align: center; }
  .stat .value {
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--blue);
  }
  .stat .label {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 600;
  }

  /* ─── Navigation ─── */
  .nav {
    display: flex;
    justify-content: center;
    gap: 4px;
    padding: 16px 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .nav button {
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-muted);
    padding: 8px 18px;
    border-radius: 6px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s ease;
  }
  .nav button:hover {
    background: var(--surface-alt);
    color: var(--text);
  }
  .nav button.active {
    background: var(--blue);
    color: #fff;
    font-weight: 600;
  }

  /* ─── Views ─── */
  .views { padding: 32px 24px 80px; }
  .view { display: none; }
  .view.active { display: block; }

  /* ─── Section Headers ─── */
  .section-header {
    text-align: center;
    margin: 0 0 28px;
  }
  .section-header h2 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.3px;
    margin-bottom: 4px;
  }
  .section-header p {
    font-size: 13px;
    color: var(--text-muted);
  }

  /* ─── SVG Diagram ─── */
  .diagram-container {
    max-width: 1340px;
    margin: 0 auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    overflow-x: auto;
  }
  .diagram-container svg {
    display: block;
    margin: 0 auto;
  }

  /* ─── Data Flow (View 2) ─── */
  .flow-diagram {
    max-width: 900px;
    margin: 0 auto;
  }
  .flow-step {
    display: flex;
    align-items: stretch;
    gap: 20px;
    margin-bottom: 2px;
  }
  .flow-step-number {
    width: 40px;
    min-width: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .flow-step-number .num {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    color: #fff;
    flex-shrink: 0;
  }
  .flow-step-number .line {
    flex: 1;
    width: 2px;
    background: var(--border);
    margin-top: 4px;
  }
  .flow-step:last-child .line { display: none; }
  .flow-step-content {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px 22px;
    margin-bottom: 6px;
  }
  .flow-step-content h4 {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .flow-step-content p {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.6;
  }
  .flow-detail {
    display: inline-block;
    background: var(--surface-alt);
    border: 1px solid var(--border);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    color: var(--cyan);
    margin: 4px 3px 0 0;
  }
  .tool-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 10px;
  }
  .tool-card {
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    text-align: center;
  }
  .tool-card .tool-name {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--cyan);
    margin-bottom: 2px;
  }
  .tool-card .tool-desc {
    font-size: 10px;
    color: var(--text-dim);
  }

  /* ─── Agent Internals (View 3) ─── */
  .agent-flow {
    max-width: 960px;
    margin: 0 auto;
  }
  .agent-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px 28px;
    margin-bottom: 14px;
  }
  .agent-section h3 {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .agent-section > p {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 14px;
  }
  .detail-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap: 10px;
  }
  .detail-item {
    background: var(--surface-alt);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
  }
  .detail-item h5 {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 3px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .detail-item p {
    font-size: 12px;
    color: var(--text);
    line-height: 1.4;
  }

  /* ─── Database Schema (View 4) ─── */
  .schema-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    max-width: 1100px;
    margin: 0 auto;
  }
  .schema-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .schema-card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface-alt);
  }
  .schema-card-header .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .schema-card-header h4 {
    font-size: 13px;
    font-weight: 700;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }
  .schema-card-body { padding: 12px 16px; }
  .schema-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 11px;
    border-bottom: 1px solid var(--surface-alt);
  }
  .schema-field:last-child { border-bottom: none; }
  .schema-field .name {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    color: var(--text);
    font-weight: 500;
  }
  .schema-field .type {
    color: var(--text-dim);
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 10px;
  }
  .schema-field .pk { color: var(--orange); font-size: 9px; font-weight: 700; margin-left: 4px; }
  .schema-field .fk { color: var(--purple); font-size: 9px; font-weight: 700; margin-left: 4px; }

  /* ─── Infrastructure (View 5) ─── */
  .infra-layout {
    max-width: 1000px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .infra-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
  }
  .infra-card.full-width { grid-column: 1 / -1; }
  .infra-card h3 {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .infra-card ul { list-style: none; }
  .infra-card li {
    padding: 6px 0;
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    align-items: flex-start;
    gap: 8px;
    border-bottom: 1px solid var(--surface-alt);
    line-height: 1.5;
  }
  .infra-card li:last-child { border-bottom: none; }
  .infra-card li .bullet {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 6px;
  }
  .infra-card li strong { color: var(--text); font-weight: 600; }
  .infra-card li code {
    background: var(--surface-alt);
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 11px;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  }

  /* ─── Footer ─── */
  .footer {
    text-align: center;
    padding: 32px 20px;
    color: var(--text-dim);
    font-size: 11px;
    border-top: 1px solid var(--border);
    max-width: 1100px;
    margin: 0 auto;
  }
</style>
</head>
<body>

<div class="header">
  <h1>The Office</h1>
  <div class="subtitle">System Architecture</div>
  <div class="date">February 2026</div>
</div>

<div class="stats-bar">
  <div class="stat"><div class="value">16</div><div class="label">AI Agents</div></div>
  <div class="stat"><div class="value">6</div><div class="label">MCP Tools</div></div>
  <div class="stat"><div class="value">30+</div><div class="label">API Endpoints</div></div>
  <div class="stat"><div class="value">9</div><div class="label">DB Tables</div></div>
  <div class="stat"><div class="value">5</div><div class="label">Eval Dimensions</div></div>
</div>

<div class="nav">
  <button class="active" onclick="switchView('overview')">Architecture Diagram</button>
  <button onclick="switchView('dataflow')">Message Flow</button>
  <button onclick="switchView('agent')">Agent Internals</button>
  <button onclick="switchView('schema')">Database Schema</button>
  <button onclick="switchView('infra')">Infrastructure</button>
</div>

<div class="views">

<!-- ═══════ VIEW 1: ARCHITECTURE DIAGRAM (SVG) ═══════ -->
<div class="view active" id="view-overview">
  <div class="diagram-container">
    <svg viewBox="0 0 1300 920" width="1300" height="920" xmlns="http://www.w3.org/2000/svg" font-family="Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">

      <!-- ═══ DEFS: arrowheads, icons ═══ -->
      <defs>
        <marker id="arrow" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6" fill="#8792a2"/>
        </marker>
        <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6" fill="#0078D4"/>
        </marker>
        <marker id="arrow-cyan" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6" fill="#0E7490"/>
        </marker>
        <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6" fill="#15803D"/>
        </marker>
        <marker id="arrow-purple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6" fill="#6B21A8"/>
        </marker>
        <marker id="arrow-orange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <path d="M0,0 L8,3 L0,6" fill="#C2410C"/>
        </marker>
        <filter id="shadow" x="-4%" y="-4%" width="108%" height="112%">
          <feDropShadow dx="0" dy="1" stdDeviation="2" flood-opacity="0.08"/>
        </filter>
      </defs>

      <!-- ═══ BACKGROUND ═══ -->
      <rect width="1300" height="920" fill="#ffffff" rx="8"/>

      <!-- ═══ ZONE: Railway (wraps Presentation + Application) ═══ -->
      <rect x="70" y="88" width="620" height="620" rx="12" fill="none" stroke="#C2410C" stroke-width="1.5" stroke-dasharray="8,4" opacity="0.35"/>
      <rect x="82" y="80" width="68" height="18" fill="#fff" rx="3"/>
      <text x="86" y="93" font-size="10" font-weight="600" fill="#C2410C" letter-spacing="0.5">RAILWAY</text>

      <!-- ═══ ZONE: Presentation Tier ═══ -->
      <rect x="110" y="130" width="550" height="130" rx="8" fill="#E8F1FB" fill-opacity="0.5" stroke="#0078D4" stroke-width="1" stroke-dasharray="6,3" opacity="0.6"/>
      <text x="126" y="150" font-size="10" font-weight="600" fill="#0078D4" letter-spacing="0.8" text-transform="uppercase">PRESENTATION</text>

      <!-- ═══ ZONE: Application Tier (Railway) ═══ -->
      <rect x="110" y="300" width="550" height="260" rx="8" fill="#F3E8FF" fill-opacity="0.35" stroke="#6B21A8" stroke-width="1" stroke-dasharray="6,3" opacity="0.6"/>
      <text x="126" y="320" font-size="10" font-weight="600" fill="#6B21A8" letter-spacing="0.8">APPLICATION LAYER</text>

      <!-- ═══ ZONE: Railway (AAS) ═══ -->
      <rect x="730" y="280" width="310" height="290" rx="12" fill="none" stroke="#0E7490" stroke-width="1.5" stroke-dasharray="8,4" opacity="0.4"/>
      <rect x="742" y="272" width="136" height="18" fill="#fff" rx="3"/>
      <text x="746" y="285" font-size="10" font-weight="600" fill="#0E7490" letter-spacing="0.5">RAILWAY (AAS)</text>

      <!-- ═══ ZONE: Evaluation ═══ -->
      <rect x="110" y="600" width="440" height="100" rx="8" fill="#FCE4EC" fill-opacity="0.4" stroke="#BE185D" stroke-width="1" stroke-dasharray="6,3" opacity="0.6"/>
      <text x="126" y="620" font-size="10" font-weight="600" fill="#BE185D" letter-spacing="0.8">EVALUATION</text>

      <!-- ═══ ZONE: Data Tier ═══ -->
      <rect x="110" y="750" width="580" height="130" rx="8" fill="#E8F5E9" fill-opacity="0.5" stroke="#15803D" stroke-width="1" stroke-dasharray="6,3" opacity="0.6"/>
      <text x="126" y="770" font-size="10" font-weight="600" fill="#15803D" letter-spacing="0.8">DATA</text>

      <!-- ═══════════════════════════════════════ -->
      <!-- ═══ SERVICE NODES ═══ -->
      <!-- ═══════════════════════════════════════ -->

      <!-- ─── User / Browser ─── -->
      <g transform="translate(300, 22)">
        <rect width="100" height="56" rx="8" fill="#fff" stroke="#dfe3ec" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="38" y="6" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#525f7f" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="3" width="20" height="14" rx="2"/>
          <path d="M8 21h8M12 17v4"/>
        </svg>
        <text x="50" y="46" text-anchor="middle" font-size="10" font-weight="600" fill="#1a1f36">Users</text>
      </g>

      <!-- ─── Next.js Frontend ─── -->
      <g transform="translate(180, 165)">
        <rect width="130" height="72" rx="8" fill="#fff" stroke="#0078D4" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0078D4" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M3 9h18M9 21V9"/>
        </svg>
        <text x="65" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">Next.js</text>
        <text x="65" y="60" text-anchor="middle" font-size="9" fill="#8792a2">React 19 + Tailwind v4</text>
      </g>

      <!-- ─── SSE Client ─── -->
      <g transform="translate(440, 165)">
        <rect width="130" height="72" rx="8" fill="#fff" stroke="#0078D4" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0078D4" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>
        </svg>
        <text x="65" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">SSE Client</text>
        <text x="65" y="60" text-anchor="middle" font-size="9" fill="#8792a2">EventSource</text>
      </g>

      <!-- ─── REST API ─── -->
      <g transform="translate(140, 340)">
        <rect width="130" height="72" rx="8" fill="#fff" stroke="#6B21A8" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6B21A8" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        <text x="65" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">REST API</text>
        <text x="65" y="60" text-anchor="middle" font-size="9" fill="#8792a2">30+ endpoints, Zod</text>
      </g>

      <!-- ─── SSE Registry ─── -->
      <g transform="translate(440, 340)">
        <rect width="130" height="72" rx="8" fill="#fff" stroke="#6B21A8" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6B21A8" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="2"/>
          <path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/>
        </svg>
        <text x="65" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">SSE Registry</text>
        <text x="65" y="60" text-anchor="middle" font-size="9" fill="#8792a2">Broadcast events</text>
      </g>

      <!-- ─── MCP Servers (Remote, on Railway) ─── -->
      <g transform="translate(140, 460)">
        <rect width="130" height="72" rx="8" fill="#fff" stroke="#6B21A8" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6B21A8" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        <text x="65" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">MCP Servers</text>
        <text x="65" y="60" text-anchor="middle" font-size="9" fill="#8792a2">6 remote tools</text>
      </g>

      <!-- ─── Scheduler ─── -->
      <g transform="translate(440, 460)">
        <rect width="120" height="72" rx="8" fill="#fff" stroke="#6B21A8" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="48" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6B21A8" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <text x="60" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">Scheduler</text>
        <text x="60" y="60" text-anchor="middle" font-size="9" fill="#8792a2">Cron triggers</text>
      </g>

      <!-- ─── AAS: Instance Registry ─── -->
      <g transform="translate(760, 310)">
        <rect width="130" height="64" rx="8" fill="#fff" stroke="#0E7490" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="6" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0E7490" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
          <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
          <line x1="6" y1="6" x2="6.01" y2="6"/>
          <line x1="6" y1="18" x2="6.01" y2="18"/>
        </svg>
        <text x="65" y="44" text-anchor="middle" font-size="10" font-weight="600" fill="#1a1f36">Instance Registry</text>
        <text x="65" y="56" text-anchor="middle" font-size="9" fill="#8792a2">Named agents (in-mem)</text>
      </g>

      <!-- ─── AAS: FIFO Queue ─── -->
      <g transform="translate(760, 400)">
        <rect width="130" height="64" rx="8" fill="#fff" stroke="#0E7490" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="53" y="6" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0E7490" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
          <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
        </svg>
        <text x="65" y="44" text-anchor="middle" font-size="10" font-weight="600" fill="#1a1f36">FIFO Queue</text>
        <text x="65" y="56" text-anchor="middle" font-size="9" fill="#8792a2">Per-instance (max 25)</text>
      </g>

      <!-- ─── AAS: SDK Executor ─── -->
      <g transform="translate(760, 490)">
        <rect width="250" height="64" rx="8" fill="#fff" stroke="#0E7490" stroke-width="2" filter="url(#shadow)"/>
        <svg x="113" y="6" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0E7490" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <text x="125" y="44" text-anchor="middle" font-size="11" font-weight="700" fill="#1a1f36">SDK Executor</text>
        <text x="125" y="56" text-anchor="middle" font-size="9" fill="#8792a2">Claude Agent SDK + Hono SSE streaming</text>
      </g>

      <!-- ─── Proposition Engine ─── -->
      <g transform="translate(140, 635)">
        <rect width="130" height="52" rx="8" fill="#fff" stroke="#BE185D" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="11" y="10" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#BE185D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20V10M18 20V4M6 20v-4"/>
        </svg>
        <text x="78" y="38" text-anchor="middle" font-size="10" font-weight="600" fill="#1a1f36">Proposition Engine</text>
        <text x="78" y="48" text-anchor="middle" font-size="8" fill="#8792a2">LLM Judge (0-9)</text>
      </g>

      <!-- ─── Adherence Scorer ─── -->
      <g transform="translate(310, 635)">
        <rect width="120" height="52" rx="8" fill="#fff" stroke="#BE185D" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="8" y="10" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#BE185D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        <text x="68" y="38" text-anchor="middle" font-size="10" font-weight="600" fill="#1a1f36">Adherence Scorer</text>
        <text x="68" y="48" text-anchor="middle" font-size="8" fill="#8792a2">5 dimensions</text>
      </g>

      <!-- ─── Drizzle ORM ─── -->
      <g transform="translate(190, 790)">
        <rect width="120" height="66" rx="8" fill="#fff" stroke="#15803D" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="48" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#15803D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
          <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
          <line x1="6" y1="6" x2="6.01" y2="6"/>
          <line x1="6" y1="18" x2="6.01" y2="18"/>
        </svg>
        <text x="60" y="48" text-anchor="middle" font-size="11" font-weight="600" fill="#1a1f36">Drizzle ORM</text>
        <text x="60" y="60" text-anchor="middle" font-size="9" fill="#8792a2">Typed queries</text>
      </g>

      <!-- ─── Neon PostgreSQL ─── -->
      <g transform="translate(440, 780)">
        <rect width="170" height="80" rx="8" fill="#fff" stroke="#15803D" stroke-width="2" filter="url(#shadow)"/>
        <svg x="73" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#15803D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <ellipse cx="12" cy="5" rx="9" ry="3"/>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
        <text x="85" y="48" text-anchor="middle" font-size="11" font-weight="700" fill="#1a1f36">Neon PostgreSQL</text>
        <text x="85" y="60" text-anchor="middle" font-size="9" fill="#8792a2">pgvector + branching</text>
        <text x="85" y="72" text-anchor="middle" font-size="9" fill="#8792a2">9 domain tables</text>
      </g>

      <!-- ─── Anthropic API (External) ─── -->
      <g transform="translate(1100, 410)">
        <rect width="150" height="80" rx="10" fill="#FFF7ED" stroke="#C2410C" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="63" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#C2410C" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        <text x="75" y="50" text-anchor="middle" font-size="11" font-weight="700" fill="#1a1f36">Anthropic API</text>
        <text x="75" y="62" text-anchor="middle" font-size="9" fill="#8792a2">Claude Haiku / Sonnet</text>
        <text x="75" y="73" text-anchor="middle" font-size="9" fill="#8792a2">Agent SDK + eval</text>
      </g>

      <!-- ─── Sentry (External) ─── -->
      <g transform="translate(1100, 200)">
        <rect width="150" height="72" rx="10" fill="#FEF2F2" stroke="#B91C1C" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="63" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#B91C1C" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        <text x="75" y="48" text-anchor="middle" font-size="11" font-weight="700" fill="#1a1f36">Sentry</text>
        <text x="75" y="60" text-anchor="middle" font-size="9" fill="#8792a2">Traces, logs, metrics</text>
      </g>

      <!-- ─── GitHub Actions (External) ─── -->
      <g transform="translate(1100, 570)">
        <rect width="150" height="72" rx="10" fill="#F0FDF4" stroke="#15803D" stroke-width="1.5" filter="url(#shadow)"/>
        <svg x="63" y="8" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#15803D" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="4"/>
          <path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"/>
        </svg>
        <text x="75" y="48" text-anchor="middle" font-size="11" font-weight="700" fill="#1a1f36">GitHub Actions</text>
        <text x="75" y="60" text-anchor="middle" font-size="9" fill="#8792a2">CI/CD, E2E, stress tests</text>
      </g>

      <!-- ═══════════════════════════════════════ -->
      <!-- ═══ CONNECTION LINES ═══ -->
      <!-- ═══════════════════════════════════════ -->

      <!-- User → Next.js (HTTP) -->
      <line x1="350" y1="78" x2="245" y2="163" stroke="#0078D4" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
      <rect x="262" y="107" width="40" height="16" rx="3" fill="#E8F1FB"/>
      <text x="282" y="118" text-anchor="middle" font-size="8" font-weight="600" fill="#0078D4">HTTP</text>

      <!-- User → SSE Client (SSE) -->
      <line x1="350" y1="78" x2="505" y2="163" stroke="#0078D4" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-blue)"/>
      <rect x="410" y="107" width="32" height="16" rx="3" fill="#E8F1FB"/>
      <text x="426" y="118" text-anchor="middle" font-size="8" font-weight="600" fill="#0078D4">SSE</text>

      <!-- Next.js ↔ SSE Client -->
      <line x1="312" y1="201" x2="438" y2="201" stroke="#0078D4" stroke-width="1.2" marker-end="url(#arrow-blue)"/>
      <line x1="438" y1="205" x2="312" y2="205" stroke="#0078D4" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arrow-blue)"/>

      <!-- Next.js → REST API -->
      <line x1="245" y1="239" x2="205" y2="338" stroke="#6B21A8" stroke-width="1.5" marker-end="url(#arrow-purple)"/>
      <rect x="198" y="276" width="42" height="16" rx="3" fill="#F3E8FF"/>
      <text x="219" y="287" text-anchor="middle" font-size="8" font-weight="600" fill="#6B21A8">REST</text>

      <!-- SSE Client ← SSE Registry -->
      <line x1="505" y1="338" x2="505" y2="239" stroke="#6B21A8" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-blue)"/>
      <rect x="510" y="276" width="48" height="16" rx="3" fill="#F3E8FF"/>
      <text x="534" y="287" text-anchor="middle" font-size="8" font-weight="600" fill="#6B21A8">events</text>

      <!-- REST API → SSE Registry (broadcast) -->
      <line x1="272" y1="376" x2="438" y2="376" stroke="#6B21A8" stroke-width="1.2" marker-end="url(#arrow-purple)"/>
      <rect x="326" y="365" width="58" height="14" rx="3" fill="#F3E8FF"/>
      <text x="355" y="375" text-anchor="middle" font-size="7" font-weight="600" fill="#6B21A8">broadcast</text>

      <!-- REST API → AAS invoke (HTTP/SSE) -->
      <line x1="272" y1="400" x2="758" y2="432" stroke="#0E7490" stroke-width="1.8" marker-end="url(#arrow-cyan)"/>
      <rect x="480" y="400" width="94" height="16" rx="3" fill="#E0F7FA"/>
      <text x="527" y="411" text-anchor="middle" font-size="8" font-weight="600" fill="#0E7490">invoke (SSE)</text>

      <!-- Scheduler → AAS invoke -->
      <line x1="562" y1="490" x2="758" y2="450" stroke="#0E7490" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arrow-cyan)"/>
      <rect x="618" y="458" width="68" height="14" rx="3" fill="#E0F7FA"/>
      <text x="652" y="468" text-anchor="middle" font-size="7" font-weight="600" fill="#0E7490">schedule</text>

      <!-- AAS Instance Registry → FIFO Queue -->
      <line x1="825" y1="376" x2="825" y2="398" stroke="#0E7490" stroke-width="1.2" marker-end="url(#arrow-cyan)"/>

      <!-- AAS FIFO Queue → SDK Executor -->
      <line x1="825" y1="466" x2="825" y2="488" stroke="#0E7490" stroke-width="1.2" marker-end="url(#arrow-cyan)"/>

      <!-- SDK Executor → Anthropic API (Claude SDK) -->
      <line x1="1012" y1="522" x2="1160" y2="472" stroke="#C2410C" stroke-width="1.8" marker-end="url(#arrow-orange)"/>
      <rect x="1060" y="486" width="80" height="16" rx="3" fill="#FFF7ED"/>
      <text x="1100" y="497" text-anchor="middle" font-size="8" font-weight="600" fill="#C2410C">Claude SDK</text>

      <!-- SDK Executor → MCP Servers (remote tool calls back to Railway) -->
      <line x1="758" y1="530" x2="272" y2="496" stroke="#6B21A8" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-purple)"/>
      <rect x="460" y="518" width="88" height="14" rx="3" fill="#F3E8FF"/>
      <text x="504" y="528" text-anchor="middle" font-size="7" font-weight="600" fill="#6B21A8">remote MCP</text>

      <!-- MCP Servers → SSE Registry (broadcast events upward) -->
      <path d="M 205 458 L 205 410 L 205 376 L 438 376" stroke="#6B21A8" stroke-width="1.2" fill="none" stroke-dasharray="4,3" marker-end="url(#arrow-purple)"/>

      <!-- MCP Servers → Data (persist) -->
      <line x1="205" y1="534" x2="205" y2="560" stroke="#8792a2" stroke-width="1" stroke-dasharray="3,3"/>
      <line x1="250" y1="560" x2="250" y2="788" stroke="#15803D" stroke-width="1.5" marker-end="url(#arrow-green)"/>
      <line x1="205" y1="560" x2="250" y2="560" stroke="#8792a2" stroke-width="1" stroke-dasharray="3,3"/>

      <!-- Evaluation → Data -->
      <line x1="370" y1="689" x2="370" y2="788" stroke="#15803D" stroke-width="1.2" stroke-dasharray="4,3" marker-end="url(#arrow-green)"/>

      <!-- Drizzle → Neon -->
      <line x1="312" y1="823" x2="438" y2="823" stroke="#15803D" stroke-width="1.5" marker-end="url(#arrow-green)"/>
      <rect x="348" y="811" width="48" height="14" rx="3" fill="#E8F5E9"/>
      <text x="372" y="821" text-anchor="middle" font-size="7" font-weight="600" fill="#15803D">queries</text>

      <!-- Railway → Sentry (traces) -->
      <line x1="660" y1="201" x2="1098" y2="230" stroke="#B91C1C" stroke-width="1" stroke-dasharray="4,4" marker-end="url(#arrow)" opacity="0.5"/>
      <!-- AAS → Sentry (traces) -->
      <line x1="1012" y1="342" x2="1098" y2="270" stroke="#B91C1C" stroke-width="1" stroke-dasharray="4,4" marker-end="url(#arrow)" opacity="0.5"/>
      <rect x="1040" y="280" width="44" height="14" rx="3" fill="#FEF2F2" opacity="0.8"/>
      <text x="1062" y="290" text-anchor="middle" font-size="7" font-weight="600" fill="#B91C1C" opacity="0.8">traces</text>

      <!-- Evaluation → Anthropic (judge calls) -->
      <path d="M 430 661 Q 800 661 1175 472" stroke="#C2410C" stroke-width="1" fill="none" stroke-dasharray="4,3" marker-end="url(#arrow-orange)" opacity="0.6"/>
      <rect x="770" y="600" width="70" height="14" rx="3" fill="#FFF7ED"/>
      <text x="805" y="610" text-anchor="middle" font-size="7" font-weight="600" fill="#C2410C">Haiku judge</text>

      <!-- ═══ LEGEND ═══ -->
      <g transform="translate(80, 890)">
        <line x1="0" y1="0" x2="24" y2="0" stroke="#525f7f" stroke-width="1.5" marker-end="url(#arrow)"/>
        <text x="30" y="4" font-size="9" fill="#8792a2">Data flow</text>

        <line x1="120" y1="0" x2="144" y2="0" stroke="#525f7f" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrow)"/>
        <text x="150" y="4" font-size="9" fill="#8792a2">Async / event-driven</text>

        <rect x="300" y="-6" width="12" height="12" rx="2" fill="none" stroke="#525f7f" stroke-width="1" stroke-dasharray="4,2"/>
        <text x="318" y="4" font-size="9" fill="#8792a2">Logical grouping</text>

        <rect x="440" y="-6" width="12" height="12" rx="2" fill="#E8F1FB" stroke="#0078D4" stroke-width="1"/>
        <text x="458" y="4" font-size="9" fill="#8792a2">Presentation</text>

        <rect x="548" y="-6" width="12" height="12" rx="2" fill="#F3E8FF" stroke="#6B21A8" stroke-width="1"/>
        <text x="566" y="4" font-size="9" fill="#8792a2">API / Railway</text>

        <rect x="640" y="-6" width="12" height="12" rx="2" fill="#E0F7FA" stroke="#0E7490" stroke-width="1"/>
        <text x="658" y="4" font-size="9" fill="#8792a2">AAS (Railway)</text>

        <rect x="750" y="-6" width="12" height="12" rx="2" fill="#FCE4EC" stroke="#BE185D" stroke-width="1"/>
        <text x="768" y="4" font-size="9" fill="#8792a2">Evaluation</text>

        <rect x="850" y="-6" width="12" height="12" rx="2" fill="#E8F5E9" stroke="#15803D" stroke-width="1"/>
        <text x="868" y="4" font-size="9" fill="#8792a2">Data</text>

        <rect x="920" y="-6" width="12" height="12" rx="2" fill="#FFF7ED" stroke="#C2410C" stroke-width="1"/>
        <text x="938" y="4" font-size="9" fill="#8792a2">External</text>
      </g>

    </svg>
  </div>
</div>

<!-- ═══════ VIEW 2: MESSAGE FLOW ═══════ -->
<div class="view" id="view-dataflow">
  <div class="section-header">
    <h2>Message Flow</h2>
    <p>End-to-end lifecycle from user input to agent response</p>
  </div>
  <div class="flow-diagram">
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--blue)">1</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--blue)">User Sends Message</h4>
        <p>User composes a message in the Slack-clone UI. The frontend calls the messages API which persists it to the database and broadcasts to all connected SSE clients.</p>
        <span class="flow-detail">POST /api/messages</span>
        <span class="flow-detail">SSE: message_created</span>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--purple)">2</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--purple)">Target Resolution</h4>
        <p>The resolver determines which agents should receive the message. For channel messages, all members (minus the sender) are targets. For thread replies, the parent author and all thread participants.</p>
        <span class="flow-detail">resolveTargetAgents()</span>
        <span class="flow-detail">Channel members - sender</span>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--cyan)">3</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--cyan)">AAS Invocation</h4>
        <p>The REST API calls the AAS service on Railway via HTTP, targeting the named agent instance (e.g. <code>dev/B/michael</code>). AAS enqueues the request in the per-instance FIFO queue (max depth 25), guaranteeing serial execution.</p>
        <span class="flow-detail">POST /v1/instances/{name}/invoke</span>
        <span class="flow-detail">SSE streaming response</span>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--green)">4</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--green)">SDK Executor (Railway)</h4>
        <p>AAS's SDK Executor runs the Claude Agent SDK with the agent's persona, memory, and context. It streams results back as SSE events (assistant_text, tool_use, tool_result, turn_complete). MCP tools are called remotely back to Railway.</p>
        <span class="flow-detail">Claude Agent SDK</span>
        <span class="flow-detail">Hono SSE streaming</span>
        <span class="flow-detail">Remote MCP tools</span>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--orange)">5</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--orange)">Agent Uses Tools</h4>
        <p>The agent decides how to respond using its 6 MCP tools. It may send a message, add a reaction, update memory, search memory, store an episodic memory, or deliberately do nothing.</p>
        <div class="tool-grid">
          <div class="tool-card"><div class="tool-name">send_message</div><div class="tool-desc">Post to channel or DM</div></div>
          <div class="tool-card"><div class="tool-name">react_to_message</div><div class="tool-desc">Add emoji reaction</div></div>
          <div class="tool-card"><div class="tool-name">do_nothing</div><div class="tool-desc">Explicit opt-out</div></div>
          <div class="tool-card"><div class="tool-name">update_memory</div><div class="tool-desc">Modify labeled blocks</div></div>
          <div class="tool-card"><div class="tool-name">search_memory</div><div class="tool-desc">Semantic recall</div></div>
          <div class="tool-card"><div class="tool-name">store_memory</div><div class="tool-desc">Archive episodes</div></div>
        </div>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--pink)">6</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--pink)">SSE Broadcast &amp; DM Chain</h4>
        <p>Each tool action broadcasts SSE events. If the agent sends a DM, the recipient agent automatically gets a new run enqueued &mdash; up to chain depth 3 to prevent infinite loops.</p>
        <span class="flow-detail">SSE: agent_typing</span>
        <span class="flow-detail">SSE: message_created</span>
        <span class="flow-detail">SSE: agent_done</span>
        <span class="flow-detail">MAX_CHAIN_DEPTH = 3</span>
      </div>
    </div>
    <div class="flow-step">
      <div class="flow-step-number">
        <div class="num" style="background:var(--red)">7</div>
        <div class="line"></div>
      </div>
      <div class="flow-step-content">
        <h4 style="color:var(--red)">Telemetry &amp; Persistence</h4>
        <p>Every step is fully traced in Sentry: spans per SDK turn, structured logs for tool calls, token usage metrics, and run history persisted in runs/runSteps/runMessages tables.</p>
        <span class="flow-detail">Sentry spans &amp; logs</span>
        <span class="flow-detail">x-sentry-trace-id header</span>
        <span class="flow-detail">Token usage tracking</span>
      </div>
    </div>
  </div>
</div>

<!-- ═══════ VIEW 3: AGENT INTERNALS ═══════ -->
<div class="view" id="view-agent">
  <div class="section-header">
    <h2>Agent Internals</h2>
    <p>How each of the 16 Office characters thinks and acts</p>
  </div>
  <div class="agent-flow">
    <div class="agent-section">
      <h3><span style="color:var(--cyan)">&#9670;</span> AAS Execution Pipeline</h3>
      <p>Agent SDK as a Service (AAS) is a long-lived Railway container that manages agent instances. Each invocation follows this pipeline:</p>
      <div class="detail-list">
        <div class="detail-item"><h5>1. Instance Lookup</h5><p>Resolve named agent instance (e.g. <code>dev/B/michael</code>) from in-memory registry. Provision on first use.</p></div>
        <div class="detail-item"><h5>2. Queue &amp; Dequeue</h5><p>Per-instance FIFO queue (max 25). Guarantees serial execution &mdash; no race conditions.</p></div>
        <div class="detail-item"><h5>3. Build Prompt</h5><p>Railway assembles modular sections: persona + core memory + tool instructions + recent messages</p></div>
        <div class="detail-item"><h5>4. Remote MCP</h5><p>6 tools served from Railway as remote MCP servers. AAS calls back to Railway during execution.</p></div>
        <div class="detail-item"><h5>5. SDK Execution</h5><p>Async generator streams Claude Agent SDK responses. SSE events: assistant_text, tool_use, tool_result, done.</p></div>
        <div class="detail-item"><h5>6. Persist &amp; Broadcast</h5><p>Railway receives SSE stream, saves run steps/messages/tokens, broadcasts to UI clients.</p></div>
      </div>
    </div>
    <div class="agent-section">
      <h3><span style="color:var(--green)">&#9670;</span> Memory Architecture</h3>
      <div class="detail-list">
        <div class="detail-item"><h5>Labeled Blocks</h5><p>Structured categories: "Personality", "Relationships", "Goals". Updated via <code>update_memory</code>. Unique per agent+label.</p></div>
        <div class="detail-item"><h5>Archival Passages</h5><p>Episodic memories stored with tags via <code>store_memory</code>. Searchable via <code>search_memory</code>.</p></div>
        <div class="detail-item"><h5>Shared Links</h5><p>Memory blocks shared between agents, enabling knowledge transfer (e.g., office gossip).</p></div>
        <div class="detail-item"><h5>Context Window</h5><p>Last 20 channel messages injected into system prompt for conversational context.</p></div>
      </div>
    </div>
    <div class="agent-section">
      <h3><span style="color:var(--orange)">&#9670;</span> Safety &amp; Guardrails</h3>
      <div class="detail-list">
        <div class="detail-item"><h5>Chain Depth Limit</h5><p>Hard cap of 3 hops for agent-to-agent DM chains. Prevents infinite conversation loops.</p></div>
        <div class="detail-item"><h5>Budget Control</h5><p>$1 max per run, 50 max turns. Prevents runaway API costs.</p></div>
        <div class="detail-item"><h5>AAS FIFO Queue</h5><p>Per-instance serial queue (max depth 25). Eliminates race conditions in memory updates.</p></div>
        <div class="detail-item"><h5>Scheduler Rate Limit</h5><p>Minimum 5 minutes between scheduled fires per agent.</p></div>
      </div>
    </div>
    <div class="agent-section">
      <h3><span style="color:var(--pink)">&#9670;</span> Persona Drift Evaluation</h3>
      <p>Based on TinyTroupe research (Microsoft, 2025). Measures how well agents stay in character over time.</p>
      <div class="detail-list">
        <div class="detail-item"><h5>Adherence</h5><p>Does the agent behave consistently with its character persona?</p></div>
        <div class="detail-item"><h5>Self-Consistency</h5><p>Are the agent's actions internally consistent across conversations?</p></div>
        <div class="detail-item"><h5>Fluency</h5><p>Does the agent communicate naturally and in-character?</p></div>
        <div class="detail-item"><h5>Convergence</h5><p>Do agents maintain distinct personalities or converge to sameness?</p></div>
        <div class="detail-item"><h5>Ideas Quantity</h5><p>Does the agent generate diverse, creative responses?</p></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════ VIEW 4: DATABASE SCHEMA ═══════ -->
<div class="view" id="view-schema">
  <div class="section-header">
    <h2>Database Schema</h2>
    <p>Neon PostgreSQL with pgvector &mdash; 9 domain tables via Drizzle ORM</p>
  </div>
  <div class="schema-grid">
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--cyan)"></div><h4>agents</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">displayName</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">title</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">systemPrompt</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">modelId</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">maxTurns / maxBudgetUsd</span><span class="type">int / numeric</span></div>
        <div class="schema-field"><span class="name">sessionId</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">isActive</span><span class="type">boolean</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--blue)"></div><h4>channels</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">name</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">kind</span><span class="type">public | private | dm</span></div>
        <div class="schema-field"><span class="name">topic</span><span class="type">text</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--blue)"></div><h4>messages</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">channelId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">parentMessageId</span><span class="type">uuid (self-ref)</span></div>
        <div class="schema-field"><span class="name">userId</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">text</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">createdAt</span><span class="type">timestamp</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--green)"></div><h4>memoryBlocks</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">agentId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">label</span><span class="type">text (unique w/ agentId)</span></div>
        <div class="schema-field"><span class="name">content</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">isShared</span><span class="type">boolean</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--green)"></div><h4>archivalPassages</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">agentId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">content</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">tags</span><span class="type">text[]</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--purple)"></div><h4>runs</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">agentId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">status</span><span class="type">created | running | ...</span></div>
        <div class="schema-field"><span class="name">triggerMessageId</span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">channelId</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">chainDepth</span><span class="type">int (max 3)</span></div>
        <div class="schema-field"><span class="name">tokenUsage</span><span class="type">jsonb</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--purple)"></div><h4>runSteps / runMessages</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">runId<span class="fk">FK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">stepNumber / messageType</span><span class="type">int / enum</span></div>
        <div class="schema-field"><span class="name">toolName</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">toolInput</span><span class="type">jsonb</span></div>
        <div class="schema-field"><span class="name">tokenUsage</span><span class="type">jsonb</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--pink)"></div><h4>evaluationRuns</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">agentId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">dimensions</span><span class="type">text[]</span></div>
        <div class="schema-field"><span class="name">overallScore</span><span class="type">real (0-9)</span></div>
        <div class="schema-field"><span class="name">isBaseline</span><span class="type">boolean</span></div>
        <div class="schema-field"><span class="name">windowStart / End</span><span class="type">timestamp</span></div>
      </div>
    </div>
    <div class="schema-card">
      <div class="schema-card-header"><div class="dot" style="background:var(--orange)"></div><h4>scheduledMessages</h4></div>
      <div class="schema-card-body">
        <div class="schema-field"><span class="name">id<span class="pk">PK</span></span><span class="type">uuid</span></div>
        <div class="schema-field"><span class="name">agentId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">triggerAt</span><span class="type">timestamp</span></div>
        <div class="schema-field"><span class="name">prompt</span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">targetChannelId<span class="fk">FK</span></span><span class="type">text</span></div>
        <div class="schema-field"><span class="name">status</span><span class="type">pending | fired | cancelled</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════ VIEW 5: INFRASTRUCTURE ═══════ -->
<div class="view" id="view-infra">
  <div class="section-header">
    <h2>Infrastructure</h2>
    <p>Cloud services, CI/CD, and development environment</p>
  </div>
  <div class="infra-layout">
    <div class="infra-card">
      <h3><span style="color:var(--orange)">&#9650;</span> Railway</h3>
      <ul>
        <li><div class="bullet" style="background:var(--orange)"></div><strong>Hosting</strong> &mdash; Edge-optimized serverless: REST API, SSE Registry, remote MCP servers, Scheduler</li>
        <li><div class="bullet" style="background:var(--orange)"></div><strong>Remote MCP</strong> &mdash; 6 agent tools served as MCP endpoints, called remotely by AAS on Railway</li>
        <li><div class="bullet" style="background:var(--orange)"></div><strong>Preview Deploys</strong> &mdash; Each PR gets an isolated preview environment with its own Neon branch</li>
      </ul>
    </div>
    <div class="infra-card">
      <h3><span style="color:var(--green)">&#9670;</span> Neon PostgreSQL</h3>
      <ul>
        <li><div class="bullet" style="background:var(--green)"></div><strong>Serverless Postgres</strong> &mdash; Auto-scaling with pgvector extension for semantic search</li>
        <li><div class="bullet" style="background:var(--green)"></div><strong>Database Branching</strong> &mdash; Isolated branches per worktree: <code>dev/A</code>, <code>dev/B</code>, <code>e2e/A</code>, etc.</li>
        <li><div class="bullet" style="background:var(--green)"></div><strong>Schema Migrations</strong> &mdash; Drizzle Kit push (dev) / generate+migrate (prod)</li>
      </ul>
    </div>
    <div class="infra-card">
      <h3><span style="color:var(--red)">&#9670;</span> Sentry</h3>
      <ul>
        <li><div class="bullet" style="background:var(--red)"></div><strong>Distributed Tracing</strong> &mdash; Every API call, agent run, and tool execution in a single trace</li>
        <li><div class="bullet" style="background:var(--red)"></div><strong>Structured Logging</strong> &mdash; Agent decisions, tool outcomes, state transitions with filterable attributes</li>
        <li><div class="bullet" style="background:var(--red)"></div><strong>Metrics</strong> &mdash; Counters (invocations, errors) and distributions (latency, cost) via OpenTelemetry</li>
        <li><div class="bullet" style="background:var(--red)"></div><strong>SDK Telemetry</strong> &mdash; Claude Agent SDK subprocess pipes metrics via OTLP to Sentry</li>
      </ul>
    </div>
    <div class="infra-card">
      <h3><span style="color:var(--cyan)">&#9670;</span> Railway (AAS)</h3>
      <ul>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>Long-lived Container</strong> &mdash; Persistent Hono HTTP server managing named agent instances with in-memory state</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>Instance Registry</strong> &mdash; Named instances (e.g. <code>dev/B/michael</code>) with CRUD lifecycle and per-instance FIFO queues</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>SSE Streaming</strong> &mdash; Real-time SDK execution events streamed back to Railway (assistant_text, tool_use, done)</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>Distributed Tracing</strong> &mdash; Sentry trace propagation across Railway &#8596; AAS boundary</li>
      </ul>
    </div>
    <div class="infra-card">
      <h3><span style="color:var(--purple)">&#9670;</span> Anthropic</h3>
      <ul>
        <li><div class="bullet" style="background:var(--purple)"></div><strong>Claude Agent SDK</strong> &mdash; Runs inside AAS on Railway with remote MCP tool integration</li>
        <li><div class="bullet" style="background:var(--purple)"></div><strong>Claude Haiku</strong> &mdash; Cost-effective model for evaluation scoring (~$0.00003/eval)</li>
        <li><div class="bullet" style="background:var(--purple)"></div><strong>Configurable Models</strong> &mdash; Per-agent model selection stored in DB for flexibility</li>
      </ul>
    </div>
    <div class="infra-card full-width">
      <h3><span style="color:var(--cyan)">&#9670;</span> CI/CD &amp; Development</h3>
      <ul>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>GitHub Actions</strong> &mdash; Automated CI: typecheck, lint, unit tests, E2E tests, and 10x stress test on every push to main</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>Git Worktrees</strong> &mdash; Up to 7 parallel workstreams (A-G) with isolated dev servers on ports 3010-3070</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>Smart Dev Server</strong> &mdash; <code>npm run dev</code> provisions Neon branch, pushes schema, seeds data automatically</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>E2E Testing</strong> &mdash; Playwright with trace capture, isolated Neon branches, zero-tolerance for server errors</li>
        <li><div class="bullet" style="background:var(--cyan)"></div><strong>Quality Gates</strong> &mdash; TypeScript strict mode, ESLint, 70% code coverage target, pre-commit hooks</li>
      </ul>
    </div>
  </div>
</div>

</div><!-- /views -->

<div class="footer">
  The Office &mdash; AI Agent Simulation &bull; Claude Agent SDK (AAS on Railway) + Neon PostgreSQL + Next.js + Sentry &bull; February 2026
</div>

<script>
  function switchView(viewId) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('view-' + viewId).classList.add('active');
    event.target.classList.add('active');
    window.scrollTo({ top: 220, behavior: 'smooth' });
  }
</script>

</body>
</html>
